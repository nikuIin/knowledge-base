[[FastAPI.canvas|FastAPI]]
[[Engine – движок SQLAlchemy]]

`engine` – это самая первая структура, которая необходима для работы с БД. `engine` в `sqlalchemy` отвечает за соединение.

Важно понимать, что при создании `engine` подключения автоматического не происходит. При создании, мы, как бы, задаем конфигурацию соединения. Чтобы работать с соединением, мы должны выполнить команду `connect()` или `begin()`.

### Давайте посмотрим на реализацию соединения и какие параметры принимает `engine`.
##### Создаем асинхронный движок.
(сихронный рассматриваться не будет)

```python
from sqlalchemy import create_async_engine

engine = create_async_engine(
	url=settings.DATABASE_URL, # DSN – database source name
	echo=True, # логирование всех запросов к БД от sqlalchemy
	pool_size=5, # количество поддерживаемых соединений (по умолча………………нию 5)
	max_overflow=10 # дополнительные соединения, создаются если pool_size достиг максимума
)
```

Дополнительные параметры:
- `pool_recycle`: Время в секундах, после которого соединение будет пересоздано при выдаче из пула. Помогает избежать проблем с устаревшими соединениями, закрытыми сервером базы данных
- `pool_pre_ping`: Если установлено True, проверяет "живость" ¬соединения перед выдачей из пула, отправляя простой запрос (например, "`select 1`"). Это помогает предотвратить ошибки из-за "мёртвых" соединений
- `pool_use_lifo`: Переключает поведение пула с `FIFO` (первым вошел, первым вышел) на `LIFO` (последним вошел, первым вышел), что может быть полезно для сокращения количества неиспользуемых соединений во время простоя
- `pool_reset_on_return`: Определяет действия, выполняемые над соединениями при их возврате в пул (например, `rollback()` по умолчанию)
##### Простое подключение к БД и выполнение запроса
```python
...

async def execute(): # мы не можем использовать асихронный контекстовый менеджер без асинхронной функции
	async with engine.connect() as conn:
		result = await conn.execute(text("select version(), current_timestamp, 1"))
		print(result.fetchone())

asyncio.run(execute())
```

Как мы уже говорили, у `engine` есть 2 типа создания подключения:
- `connect` — после выполнения **∀** запроса используется `rollback`, => явно после вставки данных нужно использовать `conn.commit()`
- `begin` — после выполнения **∀** запроса используется `commit`

Исходя из этой информации, выбираем всегда `connect`, потому что явное лучше, чем неявное.