[[Docker.canvas|Docker]]
[[docker-compose.yml]]

Сегодня настраивал `docker-compose.yml` на проекте и у меня случалось много ошибок:
- не считывались переменные окружения 
- не строился правильно образ приложения 
- не кешировался корректно образ приложения. 

Поэтому я бы хотел написать то, что мне помогло решить проблемы.
1. `docker-compose.yml`, а не `docker-compose.yAml`
2. Перестройте контейнеры, если это возможно:

```bash
docker compose up --build
```

3. Аккуратнее с названием переменных окружения. Если образ, например `postgres` запрашивает переменные для его настройки, передавайте их лучше через отдельный блок `envirenment` и всегда проверяйте, правильно ли образ запустился. Вообще, думаю, будет хорошей практикой писать 1 образ — тестировать. Из примера ниже видим, что мы явно передаем переменные для настройки и приравниваем их к нашим переменным.

```yml
services:
  db:
    image: postgres-fastapi-base-project:1.0
    build:
      context: postgres_image/
    container_name: postgres-fastapi-base-cnt
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${DB_USER} $${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - pgdata-fastapi-base:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - base-fastapi-app-network
```

4. Не всегда указание `platform` в `Docker` образах это хорошо. У вас могут возникнуть проблемы с `arm`, как это было у меня. Выход — делаем контейнер на маке, проверяем его на линуксе и маке. 
5. Копируйте программу по частям, чтобы закешировать все, что можно. Если вы будете использовать `COPY . .`, то даже изменение `docker-compose.yml` (если он в этой же директории) будет требовать перезапуск `COPY . .`. Ничего страшного, если подряд будет несколько `COPY`.
6. Иногда образ может не видеть файлы, которые вы вроде бы явно копируете. Вызывайте образ с другой командой (например `watch time -n 10`), выполняйте `exec` к контейнеру и все пристально изучайте
7. Понимайте разницу между `ENTRYPOINT` и `CMD`.  [[Разница между ENTYPOINT и CMD в Docker]]

**Важная допа:** тестируйте свой докер контейнер на всех устройствах (`windows`, `mac os`, `linux`) если не знаете, где он будет использоваться.