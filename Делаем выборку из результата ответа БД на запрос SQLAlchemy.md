[[FastAPI.canvas|FastAPI]]
[[SQLAlchemy]]
[[Engine – движок SQLAlchemy]]
[[Сырые SQL запросы в SQLAlchemy]]

Важно понимать, что следующие представленные функции **никаким образом не могу повысить производительность**. 
Хотите оптимизировать запросы? Переписывайте `sql` запрос. Ну из этого следует еще то, что не нужно писать `select * from my_table`, если вы собираетесь выбрать только 1 строку. Нужно добавить в `sql` `limit 1` ручками, поэтому вперед. 

И так, мы написали что-то вроде этого:

```python
async def get_user_creds(self, login: str) -> UserCreds | None:
	async with self.__session as session:
		result = await session.execute(GET_USER_CREDS, params={"login": login})
	result = result.??? # вот тута танцы с бубнами
```

Что мы можем делать с `result`?

##### Выбираем 1 строку разными способами
- `first()` – выбирает первую строку из оперативной памяти (первая запись в `result`) или `None`, если строк нету. Всегда возвращает первую строку.
- `one()` – более строгая версия `first()`, выбирает ровно 1 строку или выкидывает ошибку `sqlalchemy.exc.MultipleResultsFound` – при нахождении больше 1 строки и `sqlalchemy.exc.NoResultFound` – при нахождении `null` кортежей
- `fetchone()` – возвращает 1 строку или `None` и смещает указатель на следующую строку. При повторном вызове на объекте `result` вернет строку, на которую указывает указатель. То есть некий генератор (или курсор :D)
- `one_or_none()` – вернет не более 1 результата или `None`. Если поступило много строк, то вернет `sqlalchemy.exc.MultipleResultsFound`
##### Выбираем все строки
- `all()` – вернем все строки, которые были записаны в `result`
- `fetchall()` – `alias` `all()`
##### Выбираем несколько строк
Честно не понимаю зачем они нужны. Если вы выбираете часть только от всех данных, зачем захламлять оперативку? Лучше оперировать подобными параметрами, но с помощью `sql`.
- `fetchmany(size=int)` –  вернет `size` строк. Можно передать `None`, `None` = `1` для этого метода
- `partitions(size=int)` – вернет генератор заданного размера

### Кортеж в словарь

Все эти методы возвращают данные в виде `кортежей` (`tuple`) и `списков` `кортежей` (`list[tuple]`). Что, понятное дело, неудобно. У наших таблиц есть колонки, у них же есть наименования. Мы хотим получать, наверное в `dict` формате данные. С этим нам поможет метод `mappings()`, он возвращает тип `MappingResult`, который поддерживает метод `dict`. В случае, если делаем выборку по нескольким данных, он вернет `list[MappingResult]`. Он удобен и поэтому всегда его лучше применять

Пример:

```python
async def test_query(self):
	async with self.__session as session:
		result = await session.execute(text("select * from test_table"))
		res = result.mappings()
		logger.debug("Type of result: %s", res)
		res = res.fetchmany(20)
		logger.info("List: %s", res)
```